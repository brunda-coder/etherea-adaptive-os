import json
import os
from typing import Dict, Any

class WorkspaceAIHub:
    """
    Loads and manages the AI profiles for different workspaces from a JSON file.
    """
    def __init__(self):
        self.profiles: Dict[str, Any] = self._load_profiles()

    def _load_profiles(self) -> Dict[str, Any]:
        """Loads the workspace profiles from the JSON file."""
        # Correct the path to be relative to this file's location.
        dir_path = os.path.dirname(os.path.realpath(__file__))
        json_path = os.path.join(dir_path, "workspace_profiles.json")
        
        print(f"AI_HUB: Loading workspace profiles from: {json_path}")
        
        try:
            with open(json_path, 'r') as f:
                data = json.load(f)
                # Basic schema validation
                if "profiles" not in data or not isinstance(data["profiles"], dict):
                    print("ERROR: AI Hub - 'profiles.json' is missing the top-level 'profiles' dictionary.")
                    return {}
                return data["profiles"]
        except FileNotFoundError:
            print(f"ERROR: AI Hub - The profiles file was not found at {json_path}")
            return {}
        except json.JSONDecodeError:
            print(f"ERROR: AI Hub - The profiles file at {json_path} is not valid JSON.")
            return {}

    def get_profile(self, workspace_name: str) -> Dict[str, Any]:
        """
        Retrieves the AI profile for a given workspace.
        Returns a default profile if the specific one is not found.
        """
        return self.profiles.get(workspace_name, self.profiles.get("default", {}))

# Singleton instance
_ai_hub_instance = None

def get_ai_hub():
    global _ai_hub_instance
    if _ai_hub_instance is None:
        _ai_hub_instance = WorkspaceAIHub()
    return _ai_hub_instance
