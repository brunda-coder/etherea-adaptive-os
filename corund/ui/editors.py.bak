from PySide6.QtWidgets import QWidget, QVBoxLayout, QTextEdit
from PySide6.QtGui import QFont

from corund.tool_router import ToolRouter

class CodeEditorWidget(QWidget):
    def __init__(self, file_path: str = None):
        super().__init__()
        self.rel_path = file_path
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        
        self.editor = QTextEdit()
        self.editor.setLineWrapMode(QTextEdit.NoWrap)
        font = QFont("monospace")
        font.setStyleHint(QFont.Monospace)
        font.setPointSize(12)
        self.editor.setFont(font)
        self.editor.setStyleSheet("""
            QTextEdit {
                background-color: #1e1e1e;
                color: #d4d4d4;
                border: 1px solid #333;
            }
        """)
        
        layout.addWidget(self.editor)
        
        if self.rel_path:
            self.load_file(self.rel_path)
        else:
            self.load_file("corund/app_controller.py") # Default to a known file

    def load_file(self, rel_path: str):
        self.rel_path = rel_path
        print(f"EDITOR: Attempting to load file: {rel_path}")
        
        # The ToolRouter returns a dictionary
        result = ToolRouter.instance().read_file(rel_path)
        
        if result and result.get("status") == "succeeded":
            content = result.get("result", "")
            self.editor.setPlainText(content)
            print(f"EDITOR: Successfully loaded {rel_path}")
        else:
            error_message = result.get("result", f"Unknown error opening {rel_path}")
            self.editor.setPlainText(f"--- ERROR ---\n\nCould not load file: {rel_path}\n\nReason: {error_message}")
            print(f"EDITOR: Failed to load {rel_path}: {error_message}")

    def get_content(self) -> str:
        return self.editor.toPlainText()
