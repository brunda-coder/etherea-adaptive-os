import math
from PySide6.QtCore import Qt, QTimer
from PySide6.QtGui import QPainter, QColor, QBrush, QPen
from PySide6.QtWidgets import QWidget

from corund.state import get_state

class AuroraCanvasWidget(QWidget):
    """
    A widget that renders a dynamic, state-driven "aurora" effect.
    This is the single, authoritative implementation.
    """
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setMinimumSize(200, 150)
        self.state = get_state()
        self.time = 0

        # Configure the repaint timer
        self.timer = QTimer(self)
        self.timer.timeout.connect(self.update_animation)
        self.timer.start(16)  # ~60 FPS

    def update_animation(self):
        """Advances the animation timer and triggers a repaint."""
        self.time += 0.01
        self.update()  # Schedule a repaint

    def paintEvent(self, event):
        """
        Renders the aurora effect based on the current AuroraState.
        """
        painter = QPainter(self)
        painter.setRenderHint(QPainter.Antialiasing)
        painter.begin(self)

        w, h = self.width(), self.height()
        painter.fillRect(self.rect(), Qt.black)

        # Get current state from the central AuroraState
        aurora = self.state.aurora_state
        intensity = aurora.intensity
        pulse_speed = aurora.pulse_speed
        temp = aurora.temperature

        # Simple pulsing sine wave effect
        num_layers = 3
        for i in range(num_layers):
            t = self.time * pulse_speed + (i * 0.5)
            alpha = int(70 * intensity * (0.5 + 0.5 * math.sin(t * 0.3)))
            
            # Interpolate color based on temperature
            r = int(50 + 150 * temp)
            g = 50
            b = int(200 - 150 * temp)

            color = QColor(r, g, b, alpha)
            painter.setBrush(QBrush(color))
            painter.setPen(QPen(Qt.NoPen))
            
            # Layered sine waves for the aurora shape
            path = self._create_wave_path(w, h, t + i, (i + 1) * 50)
            painter.drawPath(path)

        painter.end()
        
    def _create_wave_path(self, w, h, t, amplitude):
        from PySide6.QtGui import QPainterPath
        path = QPainterPath()
        path.moveTo(0, h)
        
        segments = 20
        for i in range(segments + 1):
            x = (w / segments) * i
            y_base = h * 0.7
            y_offset = amplitude * math.sin(t + (x / w) * 4) * math.sin(t * 0.5)
            path.lineTo(x, y_base - y_offset)
            
        path.lineTo(w, h)
        path.lineTo(0, h)
        return path
