name: CI (Windows)

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-windows-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip setuptools wheel

      - name: Install deps
        shell: pwsh
        run: |
          if (Test-Path "requirements-desktop.txt") {
            pip install -r requirements-desktop.txt
          } elseif (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          } else {
            Write-Error "No requirements file found."
            exit 1
          }

      - name: Run tests (if any)
        shell: pwsh
        run: |
          if (Test-Path "pytest.ini" -or (Test-Path "tests")) {
            pip install pytest
            pytest -q
          } else {
            Write-Host "No tests detected; skipping."
          }

      - name: PyInstaller smoke build (fast)
        shell: pwsh
        run: |
          pip install pyinstaller
          $spec = Get-ChildItem -Path "." -Filter "*.spec" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $spec) {
            pyinstaller --noconfirm --clean "$($spec.Name)"
          } else {
            $entry = $null
            foreach ($cand in @("main.py","etherea_launcher.py")) {
              if (Test-Path $cand) { $entry = $cand; break }
            }
            if ($null -eq $entry) {
              Write-Host "No spec and no entrypoint; skipping smoke build."
              exit 0
            }
            pyinstaller --noconfirm --clean --name "EthereaOS" --noconsole "$entry"
          }

      - name: Upload CI artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-debug-bundle
          path: |
            dist/**
            build/**
            *.txt
            *.log
          if-no-files-found: warn
          retention-days: 7
