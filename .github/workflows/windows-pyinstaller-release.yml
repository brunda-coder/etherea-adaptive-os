name: Release Build (Windows)

on:
  release:
    types: [published]

permissions:
  contents: write

concurrency:
  group: release-windows-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip setuptools wheel

      - name: Install dependencies (desktop-first)
        shell: pwsh
        run: |
          if (Test-Path "requirements-desktop.txt") {
            pip install -r requirements-desktop.txt
          } elseif (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          } else {
            Write-Error "No requirements file found (requirements-desktop.txt / requirements.txt)."
            exit 1
          }
          pip install pyinstaller

      - name: Sanity info
        shell: pwsh
        run: |
          python --version
          pip --version
          pip freeze | Out-File -FilePath pip-freeze.txt -Encoding utf8
          git rev-parse HEAD | Out-File -FilePath git-commit.txt -Encoding utf8
          Get-ChildItem -Force | Out-String | Out-File -FilePath repo-root-tree.txt -Encoding utf8

      - name: Run tests (if any)
        shell: pwsh
        run: |
          if (Test-Path "pytest.ini" -or (Test-Path "tests")) {
            pip install pytest
            pytest -q
          } else {
            Write-Host "No tests detected; skipping."
          }

      - name: Build with PyInstaller (spec preferred)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "dist" | Out-Null
          New-Item -ItemType Directory -Force -Path "build" | Out-Null

          $spec = Get-ChildItem -Path "." -Filter "*.spec" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $spec) {
            Write-Host "Using spec: $($spec.Name)"
            pyinstaller --noconfirm --clean "$($spec.Name)"
          } else {
            # Fallback: build from a common entrypoint. Adjust if your entrypoint is different.
            $entry = $null
            foreach ($cand in @("main.py","etherea_launcher.py","core/ui/main_window_v2.py")) {
              if (Test-Path $cand) { $entry = $cand; break }
            }
            if ($null -eq $entry) {
              Write-Error "No .spec found and no known entrypoint found (main.py / etherea_launcher.py / core/ui/main_window_v2.py)."
              exit 1
            }
            Write-Host "No spec found; building from entrypoint: $entry"
            pyinstaller --noconfirm --clean --name "EthereaOS" --noconsole "$entry"
          }

      - name: Package dist into zip
        shell: pwsh
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          $zipName = "EthereaOS-${tag}-windows.zip"
          if (!(Test-Path "dist")) {
            Write-Error "dist/ not found after build."
            exit 1
          }
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path "dist\*" -DestinationPath $zipName -Force
          Write-Host "Created: $zipName"

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-bundle
          path: |
            dist/**
            build/**
            *.zip
            *.txt
            *.log
          if-no-files-found: warn
          retention-days: 14

      - name: Attach artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            EthereaOS-*-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
